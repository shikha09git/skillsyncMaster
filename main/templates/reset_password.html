{% extends 'base.html' %}
{% load static %}

{% block title %}Reset Password - SkillSync{% endblock %}

{% block extra_css %}
<style>
.sidebar{display:none!important}.main-content{margin-left:0!important}.bottom-nav{display:none!important}
.auth-icon{width:96px;height:96px;border:3px solid var(--text-primary);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;}
.auth-icon.success{border-color:var(--success);}
.auth-icon.success i{color:var(--success);}
.auth-icon i{font-size:40px;color:var(--text-primary);}
.auth-title-alt{text-align:center;font-size:18px;font-weight:600;margin-bottom:12px;}
.password-strength{margin-top:8px;}
.strength-bar{height:4px;background:var(--border-color);border-radius:2px;overflow:hidden;margin-bottom:4px;}
.strength-bar-fill{height:100%;border-radius:2px;transition:width .3s ease,background .3s ease;}
.strength-bar-fill.weak{width:25%;background:var(--danger);}
.strength-bar-fill.fair{width:50%;background:var(--warning);}
.strength-bar-fill.good{width:75%;background:#84cc16;}
.strength-bar-fill.strong{width:100%;background:var(--success);}
.strength-text{font-size:12px;}
.strength-text.weak{color:var(--danger);}
.strength-text.fair{color:var(--warning);}
.strength-text.good{color:#84cc16;}
.strength-text.strong{color:var(--success);}
.back-to-login{display:flex;align-items:center;justify-content:center;gap:8px;color:var(--text-primary);font-weight:600;font-size:14px;}
.back-to-login:hover{color:var(--accent-primary);}
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
  <div class="auth-card">
    <div class="auth-icon success"><i class="fa-solid fa-key"></i></div>
    <h2 class="auth-title-alt">Create New Password</h2>
    <p class="text-muted text-center mb-4">Must be different from previous passwords.</p>

    {% if error %}
    <div class="alert alert-error"><i class="fa-solid fa-circle-exclamation"></i>{{ error }}</div>
    {% endif %}
    {% if messages %}
      {% for message in messages %}
      <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="POST" class="auth-form" id="resetPasswordForm">
      {% csrf_token %}
      <input type="hidden" name="email" value="{{ email }}">
      <div class="form-group">
        <label class="form-label">New Password</label>
        <div class="password-wrapper">
          <input type="password" id="newPassword" name="new_password" class="form-input" required minlength="8" autocomplete="new-password">
          <button type="button" class="password-toggle" onclick="togglePassword('newPassword')"><i class="fa-regular fa-eye" id="newPasswordIcon"></i></button>
        </div>
        <div class="password-strength" id="passwordStrength"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Confirm Password</label>
        <div class="password-wrapper">
          <input type="password" id="confirmPassword" name="confirm_password" class="form-input" required autocomplete="new-password">
          <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')"><i class="fa-regular fa-eye" id="confirmPasswordIcon"></i></button>
        </div>
        <small class="text-danger" id="passwordMatchError" style="display:none;"><i class="fa-solid fa-circle-xmark"></i> Passwords do not match</small>
        <small class="text-success" id="passwordMatchSuccess" style="display:none;"><i class="fa-solid fa-circle-check"></i> Passwords match</small>
      </div>
      <button type="submit" class="btn btn-primary btn-block" id="submitBtn">Reset Password</button>
    </form>
  </div>

  <div class="auth-card auth-card-secondary">
    <a href="{% url 'login' %}" class="back-to-login"><i class="fa-solid fa-arrow-left"></i> Back to Login</a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded',function(){
  const newPassword=document.getElementById('newPassword');
  const confirmPassword=document.getElementById('confirmPassword');
  const passwordStrength=document.getElementById('passwordStrength');
  const passwordMatchError=document.getElementById('passwordMatchError');
  const passwordMatchSuccess=document.getElementById('passwordMatchSuccess');
  const submitBtn=document.getElementById('submitBtn');
  const form=document.getElementById('resetPasswordForm');

  function checkPasswordStrength(pw){
    let s=0;
    if(pw.length>=8)s++;
    if(pw.match(/[a-z]/))s++;
    if(pw.match(/[A-Z]/))s++;
    if(pw.match(/[0-9]/))s++;
    if(pw.match(/[!@#$%^&*(),.?":{}|<>]/))s++;
    return s;
  }
  function updateStrengthUI(s){
    const labels=['','Weak','Fair','Good','Strong','Strong'];
    const classes=['','weak','fair','good','strong','strong'];
    if(s===0){passwordStrength.innerHTML='';return;}
    passwordStrength.innerHTML=`
      <div class="strength-bar"><div class="strength-bar-fill ${classes[s]}"></div></div>
      <span class="strength-text ${classes[s]}">${labels[s]} password</span>`;
  }
  function validateMatch(){
    if(!confirmPassword.value){passwordMatchError.style.display='none';passwordMatchSuccess.style.display='none';return;}
    if(newPassword.value===confirmPassword.value){
      passwordMatchError.style.display='none';passwordMatchSuccess.style.display='flex';confirmPassword.classList.remove('error');
    }else{
      passwordMatchError.style.display='flex';passwordMatchSuccess.style.display='none';confirmPassword.classList.add('error');
    }
  }
  if(newPassword){
    newPassword.addEventListener('input',()=>{updateStrengthUI(checkPasswordStrength(newPassword.value));validateMatch();});
  }
  if(confirmPassword){
    confirmPassword.addEventListener('input',validateMatch);
  }
  form.addEventListener('submit',e=>{
    if(newPassword.value!==confirmPassword.value){e.preventDefault();showToast('Passwords do not match','error');return;}
    if(newPassword.value.length<8){e.preventDefault();showToast('Password must be at least 8 characters','error');return;}
    submitBtn.disabled=true;submitBtn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Resetting...';
  });
});
function togglePassword(id){
  const input=document.getElementById(id);
  const icon=document.getElementById(id+'Icon');
  if(!input||!icon)return;
  if(input.type==='password'){input.type='text';icon.className='fa-regular fa-eye-slash';}
  else{input.type='password';icon.className='fa-regular fa-eye';}
}
</script>
{% endblock %}