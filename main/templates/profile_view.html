{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile_user.username|default:profile.user.username|default:user.username }} - Profile{% endblock %}

{% block content %}
{% with owner=profile_user|default:profile.user|default:user %}
<div class="feed-container" style="max-width: 960px;">

  <!-- Header -->
  <header class="profile-header" style="display:flex;gap:32px;align-items:center;padding:24px 0;margin-bottom:16px;flex-wrap:wrap;">
    <div style="flex-shrink:0;display:flex;justify-content:center;align-items:center;">
      <div style="width:140px;height:140px;border-radius:50%;overflow:hidden;border:3px solid var(--border-light);background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:700;color:var(--text-primary);">
        {% if owner.profile and owner.profile.profile_picture and owner.profile.get_profile_picture_url %}
          <img src="{{ owner.profile.get_profile_picture_url }}" alt="{{ owner.username }}" onerror="handleImageError(this)" style="width:100%;height:100%;object-fit:cover;">
        {% else %}
          {{ owner.username|first|upper }}
        {% endif %}
      </div>
    </div>

    <div style="flex:1;min-width:260px;">
      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
        <h1 style="margin:0;font-size:22px;font-weight:700;">
          {% if owner.profile and owner.profile.full_name %}
            {{ owner.profile.full_name }}
          {% else %}
            {{ owner.username }}
          {% endif %}
        </h1>
        <span class="text-muted">@{{ owner.username }}</span>
      </div>

      <div style="display:flex;gap:24px;margin:12px 0;font-weight:600;">
        <span><strong>{{ posts_count|default:0 }}</strong> posts</span>
        <span><strong>{{ followers_count|default:0 }}</strong> followers</span>
        <span><strong>{{ following_count|default:0 }}</strong> following</span>
      </div>

      {% if owner.profile and owner.profile.profession %}
        <div class="text-muted" style="margin:4px 0;">{{ owner.profile.profession }}</div>
      {% endif %}
      {% if owner.profile and owner.profile.about %}
        <div style="margin-top:6px;color:var(--text-primary);line-height:1.5;">{{ owner.profile.about }}</div>
      {% endif %}

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;">
        {% if user == owner %}
          <a href="{% url 'edit_profile' %}" class="btn btn-secondary">Edit Profile</a>
        {% elif user.is_authenticated and owner.id %}
          {% if is_following %}
            <form method="POST" action="{% url 'unfollow' owner.id %}">{% csrf_token %}
              <button type="submit" class="btn btn-secondary">Following</button>
            </form>
          {% elif has_requested %}
            <button class="btn btn-secondary" disabled>Requested</button>
          {% else %}
            <form method="POST" action="{% url 'send_follow_request' owner.id %}">{% csrf_token %}
              <button type="submit" class="btn btn-primary">Follow</button>
            </form>
          {% endif %}
          <a href="{% url 'start_chat' owner.id %}" class="btn btn-secondary">Message</a>
        {% endif %}
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="profile-tabs" style="border-top:1px solid var(--border-color);display:flex;justify-content:center;gap:32px;margin-bottom:16px;padding-top:12px;">
    <span style="display:flex;align-items:center;gap:6px;font-weight:700;text-transform:uppercase;font-size:12px;border-top:2px solid var(--text-primary);padding-top:6px;">
      <i class="fa-solid fa-table-cells"></i> Posts
    </span>
  </div>

  <!-- Posts Grid -->
  {% if user_posts %}
    <div class="posts-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;">
      {% for post in user_posts %}
        <a href="{% url 'content_detail' post.id %}" class="posts-grid-item" style="position:relative;aspect-ratio:1/1;overflow:hidden;background:var(--bg-tertiary);">
          {% if post.image %}
            <img src="{{ post.image.url }}" alt="{{ post.title }}" loading="lazy" style="width:100%;height:100%;object-fit:cover;">
          {% elif post.video %}
            <div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);"><i class="fa-solid fa-video"></i></div>
          {% elif post.pdf %}
            <div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--danger);"><i class="fa-solid fa-file-pdf"></i></div>
          {% else %}
            <div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);"><i class="fa-solid fa-image"></i></div>
          {% endif %}
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:12px;color:white;background:rgba(0,0,0,0.45);opacity:0;transition:opacity .15s;">
            <span><i class="fa-solid fa-heart"></i> {{ post.likes.count }}</span>
            <span><i class="fa-solid fa-comment"></i> {{ post.comment_set.count }}</span>
          </div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">ðŸ“·</div>
      <h2 class="empty-state-title">No Posts Yet</h2>
      {% if user == owner %}
        <p class="empty-state-text">Share your first post with the community!</p>
        <a href="{% url 'add_content' %}" class="btn btn-primary mt-4"><i class="fa-solid fa-plus"></i> Create Post</a>
      {% else %}
        <p class="empty-state-text">{{ owner.username }} hasnâ€™t posted anything yet.</p>
      {% endif %}
    </div>
  {% endif %}

</div>

<footer class="footer">
  <div class="footer-links">
    <a href="{% url 'about' %}">About</a>
    <a href="#">Help</a>
    <a href="#">Privacy</a>
    <a href="#">Terms</a>
  </div>
  <p>Â© 2025 SkillSync</p>
</footer>
{% endwith %}
{% endblock %}

{% block extra_css %}
<style>
.posts-grid a:hover > div:last-child { opacity: 1 !important; }
@media (max-width: 600px) {
  .profile-header { flex-direction: column; align-items: flex-start; }
  .profile-header > div:first-child { align-self: center; }
  .posts-grid { grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); }
}
</style>
{% endblock %}